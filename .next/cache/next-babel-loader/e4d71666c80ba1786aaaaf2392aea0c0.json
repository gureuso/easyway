{"ast":null,"code":"import _parseInt from \"@babel/runtime-corejs2/core-js/parse-int\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport axios from 'axios';\nimport xml from 'fast-xml-parser';\nimport config from 'config.json';\nimport { Moment } from './common';\nimport { TimeUI } from './ui';\n\nclass BusUI {\n  static setWaitingTime(target, sec) {\n    const ui = new TimeUI();\n    ui.setWaitingTime(target, sec, BusUI.setCurrentBus);\n  }\n\n  static setCurrentBus(target, stId, busRouteId, ord) {\n    const api = new BusAPI();\n    api.getDataByRoute(stId, busRouteId, ord).then(data => {\n      console.log(data);\n\n      if (data) {\n        const bus = new Bus(data);\n        const waitingSec = bus.getWaitingSec();\n\n        if (waitingSec < 1) {\n          target.text(bus.message);\n        } else {\n          BusUI.setWaitingTime(target, waitingSec);\n        }\n      } else {\n        target.text('data is null');\n      }\n    });\n  }\n\n}\n\nclass BusAPI {\n  constructor() {\n    _defineProperty(this, \"API_KEY\", config.BUS_API_KEY);\n\n    _defineProperty(this, \"PROXY_HOST\", config.API_HOST);\n  }\n\n  proxy(url) {\n    return axios.get(this.PROXY_HOST + '/apis/proxy?url=' + encodeURIComponent(url)).then(response => {\n      const data = xml.parse(response.data.data.data).ServiceResult.msgBody;\n      return data ? data.itemList : undefined;\n    }).catch(error => {\n      console.log(error);\n      return undefined;\n    });\n  }\n\n  createBus(name, stationId, busRouteId, ord, token) {\n    const form = new FormData();\n    form.append('name', name);\n    form.append('station_id', stationId);\n    form.append('bus_route_id', busRouteId);\n    form.append('ord', ord);\n    form.append('token', token);\n    return axios.post(`${this.PROXY_HOST}/public_transport/buses/create`, form).then(response => {\n      return response.data.data;\n    }).catch(error => {\n      console.log(error);\n      return {};\n    });\n  }\n\n  deleteBus(id, token) {\n    return axios.delete(`${this.PROXY_HOST}/public_transport/buses/${id}/delete?token=${token}`).then(response => {\n      return response.data;\n    }).catch(error => {\n      console.log(error);\n      return {};\n    });\n  }\n\n  getBuses(token) {\n    return axios.get(`${this.PROXY_HOST}/public_transport/buses?token=${token}`).then(response => {\n      return response.data.data.buses;\n    }).catch(error => {\n      console.log(error);\n      return [];\n    });\n  }\n\n  getBusRoute(arsId) {\n    let url = 'http://ws.bus.go.kr/api/rest/stationinfo/getStationByUid?';\n    url += 'serviceKey=' + this.API_KEY;\n    url += '&arsId=' + arsId;\n    return this.proxy(url);\n  }\n\n  getBusStation(name) {\n    let url = 'http://ws.bus.go.kr/api/rest/stationinfo/getStationByName?';\n    url += 'serviceKey=' + this.API_KEY;\n    url += '&stSrch=' + name;\n    return this.proxy(url);\n  }\n\n  getDataByRoute(stId, busRouteId, ord) {\n    let url = 'http://ws.bus.go.kr/api/rest/arrive/getArrInfoByRoute?';\n    url += 'serviceKey=' + this.API_KEY;\n    url += '&stId=' + stId;\n    url += '&busRouteId=' + busRouteId;\n    url += '&ord=' + ord;\n    return this.proxy(url);\n  }\n\n}\n\nclass BusMessage {\n  constructor(message) {\n    _defineProperty(this, \"message\", void 0);\n\n    this.message = message;\n  }\n\n  getWaitingSec() {\n    const matchMinute = this.message.match(/\\d+분/g);\n    const minute = matchMinute ? _parseInt(matchMinute[0].replace('분', '')) : 0;\n    const matchSec = this.message.match(/\\d+초/g);\n    const sec = matchSec ? _parseInt(matchSec[0].replace('초', '')) : 0;\n    return minute * 60 + sec;\n  }\n\n  checkBusShutdown() {\n    if (this.message.search(/운행종료/g) != -1) {\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n}\n\nclass Bus {\n  constructor(data) {\n    _defineProperty(this, \"data\", void 0);\n\n    _defineProperty(this, \"busNum\", void 0);\n\n    _defineProperty(this, \"message\", void 0);\n\n    _defineProperty(this, \"apiCallTime\", void 0);\n\n    this.data = data;\n    this.busNum = _parseInt(this.data.rtNm);\n    this.message = this.data.arrmsg1;\n    this.apiCallTime = this.data.mkTm;\n  }\n\n  getCorrectionSec() {\n    const m = new Moment();\n    return m.getCorrectionSec(this.apiCallTime);\n  }\n\n  getWaitingSec() {\n    const bm = new BusMessage(this.message);\n    return bm.getWaitingSec() - this.getCorrectionSec();\n  }\n\n}\n\nexport { BusUI, BusAPI };","map":{"version":3,"sources":["/Users/yjh/Documents/React/easyway/lib/bus.tsx"],"names":["axios","xml","config","Moment","TimeUI","BusUI","setWaitingTime","target","sec","ui","setCurrentBus","stId","busRouteId","ord","api","BusAPI","getDataByRoute","then","data","console","log","bus","Bus","waitingSec","getWaitingSec","text","message","BUS_API_KEY","API_HOST","proxy","url","get","PROXY_HOST","encodeURIComponent","response","parse","ServiceResult","msgBody","itemList","undefined","catch","error","createBus","name","stationId","token","form","FormData","append","post","deleteBus","id","delete","getBuses","buses","getBusRoute","arsId","API_KEY","getBusStation","BusMessage","constructor","matchMinute","match","minute","replace","matchSec","checkBusShutdown","search","busNum","rtNm","arrmsg1","apiCallTime","mkTm","getCorrectionSec","m","bm"],"mappings":"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","sourcesContent":["import axios from 'axios';\nimport xml from 'fast-xml-parser';\n\nimport config from 'config.json';\nimport { Moment } from './common';\nimport { TimeUI } from './ui';\n\nclass BusUI {\n  static setWaitingTime(target: JQuery<HTMLElement>, sec: number) {\n    const ui = new TimeUI();\n    ui.setWaitingTime(target, sec, BusUI.setCurrentBus);\n  }\n\n  static setCurrentBus(target: JQuery<HTMLElement>, stId: number, busRouteId: number, ord: number) {\n    const api = new BusAPI();\n    api.getDataByRoute(stId, busRouteId, ord).then(data => {\n      console.log(data)\n      if(data) {\n        const bus = new Bus(data);\n        const waitingSec = bus.getWaitingSec();\n        if(waitingSec < 1) {\n          target.text(bus.message);\n        } else {\n          BusUI.setWaitingTime(target, waitingSec);\n        }\n      } else {\n        target.text('data is null');\n      }\n    });\n  }\n}\n\nclass BusAPI {\n  API_KEY: string = config.BUS_API_KEY;\n  PROXY_HOST: string = config.API_HOST;\n\n  proxy(url: string) {\n    return axios.get(this.PROXY_HOST + '/apis/proxy?url=' + encodeURIComponent(url))\n    .then(response => {\n      const data = xml.parse(response.data.data.data).ServiceResult.msgBody;\n      return data ? data.itemList : undefined;\n    })\n    .catch(error => {\n      console.log(error);\n      return undefined;\n    });\n  }\n\n  createBus(name: string, stationId: string, busRouteId: string, ord: string, token: string) {\n    const form = new FormData();\n    form.append('name', name);\n    form.append('station_id', stationId);\n    form.append('bus_route_id', busRouteId);\n    form.append('ord', ord);\n    form.append('token', token);\n\n    return axios.post(`${this.PROXY_HOST}/public_transport/buses/create`, form)\n    .then(response => {\n      return response.data.data;\n    })\n    .catch(error => {\n      console.log(error);\n      return {};\n    });\n  }\n\n  deleteBus(id: number, token: string) {\n    return axios.delete(`${this.PROXY_HOST}/public_transport/buses/${id}/delete?token=${token}`)\n    .then(response => {\n      return response.data;\n    })\n    .catch(error => {\n      console.log(error);\n      return {};\n    });\n  }\n\n  getBuses(token: string) {\n    return axios.get(`${this.PROXY_HOST}/public_transport/buses?token=${token}`)\n    .then(response => {\n      return response.data.data.buses;\n    })\n    .catch(error => {\n      console.log(error);\n      return [];\n    });\n  }\n\n  getBusRoute(arsId: string) {\n    let url = 'http://ws.bus.go.kr/api/rest/stationinfo/getStationByUid?'\n    url += 'serviceKey=' + this.API_KEY;\n    url += '&arsId=' + arsId;\n\n    return this.proxy(url);\n  }\n\n  getBusStation(name: string) {\n    let url = 'http://ws.bus.go.kr/api/rest/stationinfo/getStationByName?'\n    url += 'serviceKey=' + this.API_KEY;\n    url += '&stSrch=' + name;\n\n    return this.proxy(url);\n  }\n\n  getDataByRoute(stId: number, busRouteId: number, ord: number) {\n    let url = 'http://ws.bus.go.kr/api/rest/arrive/getArrInfoByRoute?';\n    url += 'serviceKey=' + this.API_KEY;\n    url += '&stId=' + stId;\n    url += '&busRouteId=' + busRouteId;\n    url += '&ord=' + ord;\n\n    return this.proxy(url);\n  }\n}\n\nclass BusMessage {\n  message: string;\n\n  constructor(message: string) {\n    this.message = message;\n  }\n\n  getWaitingSec(): number {\n    const matchMinute = this.message.match(/\\d+분/g)!;\n    const minute = matchMinute ? parseInt(matchMinute[0].replace('분', '')) : 0;\n    const matchSec = this.message.match(/\\d+초/g)!;\n    const sec = matchSec ? parseInt(matchSec[0].replace('초', '')) : 0;\n    return minute * 60 + sec;\n  }\n\n  checkBusShutdown(): boolean {\n    if(this.message.search(/운행종료/g) != -1) {\n      return true;\n    } else {\n      return false;\n    }\n  }\n}\n\nclass Bus {\n  data: {[key: string]: any};\n  busNum: number;\n  message: string;\n  apiCallTime: string;\n\n  constructor(data: {[key: string]: any}) {\n    this.data = data;\n    this.busNum = parseInt(this.data.rtNm);\n    this.message = this.data.arrmsg1;\n    this.apiCallTime = this.data.mkTm;\n  }\n\n  private getCorrectionSec(): number {\n    const m = new Moment();\n    return m.getCorrectionSec(this.apiCallTime);\n  }\n\n  getWaitingSec(): number {\n    const bm = new BusMessage(this.message);\n    return bm.getWaitingSec() - this.getCorrectionSec();\n  }\n}\n\nexport { BusUI, BusAPI };\n"]},"metadata":{},"sourceType":"module"}